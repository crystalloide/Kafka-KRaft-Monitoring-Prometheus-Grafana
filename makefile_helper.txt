.PHONY: help setup up down restart logs clean test-topic produce consume metrics

help: ## Afficher cette aide
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

setup: ## TÃ©lÃ©charger les dÃ©pendances et configurer l'environnement
	@echo "ğŸš€ Configuration de l'environnement..."
	@chmod +x setup.sh
	@./setup.sh

up: ## DÃ©marrer tous les services
	@echo "ğŸš€ DÃ©marrage des services..."
	@docker compose up -d
	@echo "âœ… Services dÃ©marrÃ©s!"
	@echo ""
	@echo "ğŸ“Š AccÃ¨s aux interfaces:"
	@echo "  - Grafana:     http://localhost:3000 (admin/admin)"
	@echo "  - Prometheus:  http://localhost:9090"
	@echo "  - Kafka UI:    http://localhost:8888"
	@echo ""

down: ## ArrÃªter tous les services
	@echo "ğŸ›‘ ArrÃªt des services..."
	@docker compose down

restart: ## RedÃ©marrer tous les services
	@echo "ğŸ”„ RedÃ©marrage des services..."
	@docker compose restart

logs: ## Afficher les logs de tous les services
	@docker compose logs -f

logs-kafka: ## Afficher les logs des brokers Kafka
	@docker compose logs -f kafka-1 kafka-2 kafka-3

logs-prometheus: ## Afficher les logs de Prometheus
	@docker compose logs -f prometheus

logs-grafana: ## Afficher les logs de Grafana
	@docker compose logs -f grafana

status: ## Afficher le statut des services
	@docker compose ps

clean: ## ArrÃªter et supprimer les conteneurs et volumes
	@echo "ğŸ§¹ Nettoyage complet..."
	@docker compose down -v
	@echo "âœ… Nettoyage terminÃ©!"

clean-all: ## Nettoyage complet incluant les images
	@echo "ğŸ§¹ Nettoyage complet avec images..."
	@docker compose down -v --rmi all
	@echo "âœ… Nettoyage terminÃ©!"

test-topic: ## CrÃ©er un topic de test
	@echo "ğŸ“ CrÃ©ation du topic 'test-topic'..."
	@docker exec -it kafka-1 kafka-topics \
		--bootstrap-server kafka-1:29091 \
		--create \
		--topic test-topic \
		--partitions 3 \
		--replication-factor 3 \
		--if-not-exists
	@echo "âœ… Topic crÃ©Ã©!"

list-topics: ## Lister tous les topics
	@docker exec -it kafka-1 kafka-topics \
		--bootstrap-server kafka-1:29091 \
		--list

describe-topic: ## DÃ©crire un topic (usage: make describe-topic TOPIC=test-topic)
	@docker exec -it kafka-1 kafka-topics \
		--bootstrap-server kafka-1:29091 \
		--describe \
		--topic $(TOPIC)

produce: ## Ouvrir un producer interactif (usage: make produce TOPIC=test-topic)
	@echo "âœï¸  Producer pour le topic '$(TOPIC)'"
	@echo "Tapez vos messages et appuyez sur EntrÃ©e (Ctrl+C pour quitter)"
	@docker exec -it kafka-1 kafka-console-producer \
		--bootstrap-server kafka-1:29091 \
		--topic $(TOPIC)

consume: ## Ouvrir un consumer interactif (usage: make consume TOPIC=test-topic)
	@echo "ğŸ“– Consumer pour le topic '$(TOPIC)'"
	@docker exec -it kafka-1 kafka-console-consumer \
		--bootstrap-server kafka-1:29091 \
		--topic $(TOPIC) \
		--from-beginning

load-test: ## GÃ©nÃ©rer de la charge sur le topic test-topic
	@echo "ğŸ”¥ GÃ©nÃ©ration de charge..."
	@for i in $$(seq 1 1000); do \
		echo "Message $$i - $$(date)" | docker exec -i kafka-1 kafka-console-producer \
			--bootstrap-server kafka-1:29091 \
			--topic test-topic; \
		sleep 0.01; \
	done
	@echo "âœ… 1000 messages envoyÃ©s!"

metrics: ## Afficher les mÃ©triques JMX Exporter
	@echo "ğŸ“Š MÃ©triques Kafka-1:"
	@curl -s http://localhost:8080/metrics | head -20
	@echo ""
	@echo "ğŸ“Š MÃ©triques Kafka-2:"
	@curl -s http://localhost:8081/metrics | head -20
	@echo ""
	@echo "ğŸ“Š MÃ©triques Kafka-3:"
	@curl -s http://localhost:8082/metrics | head -20

check-prometheus: ## VÃ©rifier les targets Prometheus
	@echo "ğŸ” VÃ©rification des targets Prometheus..."
	@curl -s http://localhost:9090/api/v1/targets | jq '.data.activeTargets[] | {job: .labels.job, health: .health, lastError: .lastError}'

open-grafana: ## Ouvrir Grafana dans le navigateur
	@echo "ğŸŒ Ouverture de Grafana..."
	@open http://localhost:3000 || xdg-open http://localhost:3000 || start http://localhost:3000

open-prometheus: ## Ouvrir Prometheus dans le navigateur
	@echo "ğŸŒ Ouverture de Prometheus..."
	@open http://localhost:9090 || xdg-open http://localhost:9090 || start http://localhost:9090

open-kafka-ui: ## Ouvrir Kafka UI dans le navigateur
	@echo "ğŸŒ Ouverture de Kafka UI..."
	@open http://localhost:8888 || xdg-open http://localhost:8888 || start http://localhost:8888

shell-kafka: ## Ouvrir un shell dans le conteneur kafka-1
	@docker exec -it kafka-1 /bin/bash

shell-prometheus: ## Ouvrir un shell dans le conteneur Prometheus
	@docker exec -it prometheus /bin/sh

shell-grafana: ## Ouvrir un shell dans le conteneur Grafana
	@docker exec -it grafana /bin/bash

backup-grafana: ## Sauvegarder les donnÃ©es Grafana
	@echo "ğŸ’¾ Sauvegarde des donnÃ©es Grafana..."
	@docker exec grafana tar czf /tmp/grafana-backup.tar.gz /var/lib/grafana
	@docker cp grafana:/tmp/grafana-backup.tar.gz ./grafana-backup-$$(date +%Y%m%d-%H%M%S).tar.gz
	@echo "âœ… Sauvegarde crÃ©Ã©e!"

install: setup up ## Installation complÃ¨te (setup + dÃ©marrage)
	@echo "âœ… Installation terminÃ©e!"
	@echo ""
	@echo "ğŸ‰ Votre environnement Kafka + Monitoring est prÃªt!"
	@echo ""
	@make open-grafana

# Variables par dÃ©faut
TOPIC ?= test-topic
